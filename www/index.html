<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The OpenQasm playground!</title>
    <link rel="stylesheet" href="./vendor/mathbox-0.0.5/mathbox.css">
  </head>
  <body>
    <noscript>This page contains webassembly and javascript content, please enable javascript in your browser.</noscript>
    <script src="./bootstrap.js"></script>
    <script src="./vendor/mathbox-0.0.5/mathbox-bundle.js"></script>
    <h1>The OpenQasm playground</h1>
    <section class="qasm-playground">
      <div class="qasm-playground__source-area">
        <ul class="qasm-playground__control-panel program-control">
          <li class="program-control__button">
            <button class="program-control__button-run">Run</button>
          </li>
        </ul>
        <textarea class="qasm-playground__source-editor" cols="80" rows="20">
OPENQASM 2.0;
include "qelib1.inc";
qreg q[2];
h q[0];
cx q[0], q[1];</textarea>
        <textarea disabled class="qasm-playground__log" cols="80" rows="10"></textarea>
      </div>
      <div class="qasm-playground__results-area">
      </div>
    </section>
    <script>
      (async function () {
        await window._loadDependencies

        const $ = document.querySelector.bind(document)

        $('.program-control__button-run').addEventListener('click', () => {
          logCommand('run')

          let execution;
          try {
            const code = $('.qasm-playground__source-editor').value;
            execution = qasmsim.run(code)
          } catch (err) {
            logOutput(err.message)
            return
          }

          logTimes(execution.times)
          updateResults(execution.statevector, svVis)
        })

        $('.qasm-playground__source-editor').addEventListener('keypress', (evt) => {
          if (evt.ctrlKey && evt.key === 'Enter') {
            $('.program-control__button-run').click()
          }
        })

        const svVis = window.svVis = initStateVectorVisualization('.qasm-playground__results-area')

        function initStateVectorVisualization(el) {
          const root = mathBox({
            element: $(el),
            classes: ['sv-visualization'],
            plugins: ['core', 'controls', 'cursor', 'mathbox'],
            controls: {
              klass: THREE.TrackballControls
            }
          })
          root.three.renderer.setClearColor(new THREE.Color(0xFFFFFF), 1.0);
          root.camera({
            proxy: true,
            position: [0, 0, 3]
          })
          const view = root.cartesian({
            classes: ['view'],
            range: [[0, 31], [-1, 1], [-1, 1]],
            scale: [2, 1, 1],
          })
          view
            .axis({
              classes: ['axis-bases'],
              axis: 1,
            })
            .axis({
              classes: ['axis-re'],
              axis: 2,
            })
            .axis({
              classes: ['axis-im'],
              axis: 3,
            })
          view
            .interval({
              classes: ['bases'],
              width: 32,
              channels: 3,
              items: 2,
              live: false
            })
            .vector({
              end: true,
              width: 5,
              color: '#50A000',
            })
          return root
        }

        function updateResults(statevector, visRoot) {
          const bases = statevector.bases
          const qubitWidth = statevector.qubitWidth
          console.log(bases)
          const len = bases.length / 2
          visRoot.select('.scale')
            .set({
              divide: len
            })
          visRoot.select('.labels')
            .set({
              expr: function (x) {
                return x.toString(2).padStart(qubitWidth, '0')
              }
            })
          visRoot.select('.view')
            .set({
              range: [[0, len - 1], [-1, 1], [-1, 1]],
            })
          visRoot.select('.bases')
            .set({
              expr: function (emit, x, i, t) {
                const [reIdx, imIdx] = [2 * i, 2 * i + 1]
                emit(i, 0, 0)
                emit(i, bases[reIdx], bases[imIdx])
              },
              width: len,
              live: false
            })
        }

        function logTimes(times) {
          const values = [
            `parsing: ${times.parsing.duration}ms`,
            `simulation: ${times.simulation.duration}ms`,
            `serialization: ${times.serialization.duration}ms`
          ]
          logOutput(values.join('\n'))
        }

        function logCommand(command) {
          logOutput(`> ${command}`)
        }

        function logOutput(message) {
          const textarea = $('.qasm-playground__log')
          textarea.innerHTML += `${message}\n`
          textarea.scrollTop = textarea.scrollHeight
        }
      }())
    </script>
    <style>
      .qasm-playground {
        display: flex;
        width: 100%;
      }

      .qasm-playground__source-area {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .qasm-playground__results-area {
        margin-top: 2rem;
        margin-left: 0.5rem;
        flex: 1;
      }

      .qasm-playground__control-panel {
        width: 100%;
        box-sizing: border-box;
      }

      .qasm-playground__source-editor {
        resize: none;
        width: 100%;
        overflow: scroll;
        box-sizing: border-box;
      }

      .qasm-playground__log {
        color: black;
        resize: none;
        width: 100%;
        overflow: scroll;
        box-sizing: border-box;
      }

      .program-control {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .program-control__button-run {
        height: 2rem;
      }
    </style>
  </body>
</html>
