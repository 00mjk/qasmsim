<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The OpenQasm playground!</title>
    <link rel="stylesheet" href="./vendor/mathbox-0.0.5/mathbox.css">
  </head>
  <body>
    <noscript>This page contains webassembly and javascript content, please enable javascript in your browser.</noscript>
    <script src="./bootstrap.js"></script>
    <script src="./vendor/mathbox-0.0.5/mathbox-bundle.js"></script>
    <h1>The OpenQasm playground</h1>
    <section class="qasm-playground">
      <div class="qasm-playground__source-area">
        <ul class="qasm-playground__control-panel program-control">
          <li class="program-control__button">
            <button class="program-control__button-run">Run</button>
          </li>
        </ul>
        <textarea class="qasm-playground__source-editor" cols="80" rows="20">
OPENQASM 2.0;
include "qelib1.inc";
qreg q[2];
h q[0];
cx q[0], q[1];</textarea>
        <textarea disabled class="qasm-playground__log" cols="80" rows="10"></textarea>
      </div>
      <div class="qasm-playground__results-area">
      </div>
    </section>
    <script>
      (async function () {
        await window._loadDependencies

        const $ = document.querySelector.bind(document)

        $('.program-control__button-run').addEventListener('click', () => {
          logCommand('run')

          let execution;
          try {
            const code = $('.qasm-playground__source-editor').value;
            execution = qasmsim.run(code)
          } catch (err) {
            logOutput(err.message)
            return
          }

          logTimes(execution.times)
          updateResults(execution.statevector, svVis)
        })

        $('.qasm-playground__source-editor').addEventListener('keypress', (evt) => {
          if (evt.ctrlKey && evt.key === 'Enter') {
            $('.program-control__button-run').click()
          }
        })

        const svVis = window.svVis = initStateVectorVisualization('.qasm-playground__results-area')

        let start = null
        let end = null
        let duration = 1
        let oldData = null
        let newData = null

        function toPolar(complexArr) {
          const len = complexArr.length / 2
          for (let i = 0; i < len; i++) {
            const re = complexArr[2*i]
            const im = complexArr[2*i+1]
            const modu = Math.sqrt(re*re + im*im)
            const angl = modu === 0 ? 0 : Math.atan(im/re)
            complexArr[2*i] = modu
            complexArr[2*i+1] = angl
          }
          return complexArr
        }

        function initStateVectorVisualization(el) {
          const root = mathBox({
            element: $(el),
            classes: ['sv-visualization'],
            plugins: ['core', 'controls', 'cursor'],
            controls: {
              klass: THREE.TrackballControls
            }
          })
          root.three.renderer.setClearColor(new THREE.Color(0xFFFFFF), 1.0);
          root.camera({
            proxy: true,
            position: [0, 0, 3]
          })
          const view = root.cartesian({
            classes: ['view'],
            range: [[0, 3], [-1, 1], [-1, 1]],
            scale: [2, 1, 1],
          })
          view
            .axis({
              classes: ['axis-bases'],
              axis: 1,
            })
            .axis({
              classes: ['axis-re'],
              axis: 2,
            })
            .axis({
              classes: ['axis-im'],
              axis: 3,
            })
          view
            .interval({
              classes: ['bases'],
              width: 4,
              expr: (emit, x, i, t) => {
                if (!newData) { return }
                start = start || t
                end = end || (start + duration)
                const startModu = !oldData ? 0 : Math.hypot(oldData[2*i], oldData[2*i+1])
                const startAngl = !oldData ? 0 : Math.atan2(oldData[2*i], oldData[2*i+1])
                const endModu = Math.hypot(newData[2*i], newData[2*i+1])
                const endAngl = Math.atan2(newData[2*i], newData[2*i+1])
                const progress = Math.min(1.0, (t - start) / (end - start))
                const nextAmpl = progress * (endModu - startModu) + startModu
                const nextAngl = progress * (endAngl - startAngl) + startAngl
                emit(i, 0, 0)
                emit(i, nextAmpl * Math.sin(nextAngl), nextAmpl * Math.cos(nextAngl))
              },
              channels: 3,
              items: 2
            })
            .vector({
              end: true,
              width: 5,
              color: '#50A000',
            })
          return root
        }

        function updateResults(statevector, visRoot) {
          oldData = newData
          newData = statevector.bases
          const len = newData.length / 2
          const isDifferent = !oldData || oldData.length !== newData.length

          if (isDifferent) {
            oldData = null
            visRoot.select('.scale')
              .set({
                divide: len
              })
            visRoot.select('.view')
              .set({
                range: [[0, len - 1], [-1, 1], [-1, 1]],
              })
          }

          start = null
          end = null

          console.log('Old bases:', oldData)
          console.log('New bases:', newData)
        }

        function logTimes(times) {
          const values = [
            `parsing: ${times.parsing.duration}ms`,
            `simulation: ${times.simulation.duration}ms`,
            `serialization: ${times.serialization.duration}ms`
          ]
          logOutput(values.join('\n'))
        }

        function logCommand(command) {
          logOutput(`> ${command}`)
        }

        function logOutput(message) {
          const textarea = $('.qasm-playground__log')
          textarea.innerHTML += `${message}\n`
          textarea.scrollTop = textarea.scrollHeight
        }
      }())
    </script>
    <style>
      .qasm-playground {
        display: flex;
        width: 100%;
      }

      .qasm-playground__source-area {
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .qasm-playground__results-area {
        margin-top: 2rem;
        margin-left: 0.5rem;
        flex: 1;
      }

      .qasm-playground__control-panel {
        width: 100%;
        box-sizing: border-box;
      }

      .qasm-playground__source-editor {
        resize: none;
        width: 100%;
        overflow: scroll;
        box-sizing: border-box;
      }

      .qasm-playground__log {
        color: black;
        resize: none;
        width: 100%;
        overflow: scroll;
        box-sizing: border-box;
      }

      .program-control {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .program-control__button-run {
        height: 2rem;
      }
    </style>
  </body>
</html>
